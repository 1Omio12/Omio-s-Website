<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMC Simulation Results - Job {{ job_id }}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 25%, #2d2d2d 50%, #1a1a1a 75%, #000000 100%); background-attachment: fixed; min-height: 100vh; color: #ffffff; padding: 20px; position: relative; }
        body::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle at 20% 20%, rgba(120, 119, 198, 0.1) 0%, transparent 50%), radial-gradient(circle at 80% 80%, rgba(255, 118, 117, 0.1) 0%, transparent 50%), radial-gradient(circle at 40% 40%, rgba(162, 155, 254, 0.05) 0%, transparent 50%); pointer-events: none; z-index: 0; }
        .container { max-width: 1400px; margin: 0 auto; position: relative; z-index: 1; }
        .header { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; margin-bottom: 30px; text-align: center; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1); animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .header h1 { font-size: 2.5rem; font-weight: 600; background: linear-gradient(135deg, #a8edea, #fed6e3, #d299c2, #fef9d7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-shadow: 0 0 30px rgba(255, 255, 255, 0.3); margin-bottom: 10px; }
        .job-info { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin-top: 20px; }
        .job-info-item { background: rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 10px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .job-info-item strong { color: #a8edea; }
        .status { padding: 8px 16px; border-radius: 20px; font-weight: 600; display: inline-block; margin: 10px 0; }
        .status.completed { background: linear-gradient(135deg, #4ade80, #22c55e); color: white; }
        .status.running { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
        .status.failed { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
        .status.queued { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        .card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 20px; padding: 30px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.1); animation: slideUp 0.6s ease-out; }
        .card h2 { color: #a8edea; margin-bottom: 20px; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .results-table th { background: rgba(255, 255, 255, 0.1); color: #a8edea; font-weight: 600; }
        .results-table tr:hover { background: rgba(255, 255, 255, 0.05); }
        .keff-highlight { background: linear-gradient(135deg, rgba(168, 237, 234, 0.2), rgba(254, 214, 227, 0.2)); border-radius: 8px; padding: 4px 8px; font-weight: 600; }
        .geometry-section { grid-column: 1 / -1; }
        .plot-controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; padding: 20px; background: rgba(255, 255, 255, 0.1); border-radius: 15px; border: 1px solid rgba(255, 255, 255, 0.2); }
        .control-group { display: flex; flex-direction: column; gap: 8px; }
        .control-group label { font-weight: 600; color: #e0e0e0; font-size: 0.95rem; }
        .control-group input, .control-group select { padding: 10px 12px; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: #ffffff; font-size: 0.9rem; transition: all 0.3s ease; }
        .control-group input:focus, .control-group select:focus { outline: none; border-color: rgba(168, 237, 234, 0.6); box-shadow: 0 0 0 3px rgba(168, 237, 234, 0.1); background: rgba(255, 255, 255, 0.1); }
        .control-group select option { background: #2d2d2d; color: #ffffff; }
        .generate-btn { background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .generate-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .generate-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
        .plot-gallery { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px; }
        .plot-container { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); text-align: center; }
        .plot-container h3 { color: #a8edea; margin-bottom: 15px; font-size: 1.2rem; }
        .plot-container img { max-width: 100%; height: auto; border-radius: 10px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); }
        .plot-container .no-plot { color: #888; font-style: italic; padding: 40px 20px; background: rgba(255, 255, 255, 0.02); border-radius: 10px; border: 2px dashed rgba(255, 255, 255, 0.1); }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .loading-content { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(20px); padding: 30px; border-radius: 15px; text-align: center; color: white; }
        .spinner { width: 40px; height: 40px; border: 4px solid rgba(255, 255, 255, 0.3); border-top: 4px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .back-btn { background: linear-gradient(135deg, #4b5563, #374151); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; text-decoration: none; display: inline-block; margin-bottom: 20px; }
        .back-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(75, 85, 99, 0.4); }
        .error-message { background: linear-gradient(135deg, #fca5a5, #ef4444); color: white; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: center; }
        .preview-btn { background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; padding: 10px 16px; border-radius: 6px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px; }
        .preview-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
        .chart-container { background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.1); margin-top: 20px; }
        .chart-container h3 { color: #a8edea; margin-bottom: 15px; text-align: center; }
        .chart-container img { max-width: 100%; height: auto; border-radius: 10px; display: block; margin: 0 auto; }
        @media (max-width: 768px) { .content-grid { grid-template-columns: 1fr; } .plot-controls { grid-template-columns: 1fr; } .plot-gallery { grid-template-columns: 1fr; } .job-info { flex-direction: column; gap: 15px; } .header h1 { font-size: 2rem; } }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">‚Üê Back to Home</a>
        <div class="header">
            <h1>üöÄ Simulation Results üöÄ</h1>
            <div class="job-info">
                <div class="job-info-item"><strong>Job ID:</strong> {{ job_id or 'N/A' }}</div>
                <div class="job-info-item"><strong>Cross-Sections:</strong> {{ cross_sections_used or 'N/A' }}</div>
                <div class="job-info-item"><strong>Status:</strong> <span class="status {{ status.split(':')[0] if status else 'unknown' }}">{{ status or 'Unknown' }}</span></div>
            </div>
        </div>

        {% if status == 'completed' %}
        <div class="content-grid">
            <div class="card">
                <h2>üìä Simulation Results</h2>
                {% if results %}
                <table class="results-table">
                    <thead><tr><th>Metric</th><th>Value</th><th>Uncertainty</th></tr></thead>
                    <tbody>
                        {% for result in results %}
                        <tr>
                            <td>{{ result.metric }}</td>
                            <td class="{% if 'k-effective' in result.metric %}keff-highlight{% endif %}">{{ result.value }}</td>
                            <td>{{ result.uncertainty }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="error-message">No simulation results available. The simulation may have failed or data extraction encountered issues.</div>
                {% endif %}
            </div>
            <div class="card">
                <h2>üìà Tally Results</h2>
                {% if plot_data %}
                <div class="chart-container"><img src="data:image/png;base64,{{ plot_data }}" alt="Tally Results Chart"></div>
                {% else %}
                <div class="plot-container"><div class="no-plot">No tally data available or no tallies were defined in the simulation.</div></div>
                {% endif %}
            </div>
        </div>

        <div class="card geometry-section">
            <h2>üîç Geometry Visualization</h2>
            <div class="plot-controls">
                <div class="control-group"><label for="width">Width (cm):</label><input type="number" id="width" value="20" min="0.1" max="1000" step="0.1"></div>
                <div class="control-group"><label for="height">Height (cm):</label><input type="number" id="height" value="20" min="0.1" max="1000" step="0.1"></div>
                <div class="control-group"><label for="basis">View Plane:</label><select id="basis"><option value="xy">XY Plane</option><option value="xz">XZ Plane</option><option value="yz">YZ Plane</option></select></div>
                <div class="control-group"><label for="resolution">Resolution (pixels):</label><input type="number" id="resolution" value="800" min="100" max="3000" step="50"></div>
                <div class="control-group"><label for="origin_x">Origin X (cm):</label><input type="number" id="origin_x" value="0" step="0.1"></div>
                <div class="control-group"><label for="origin_y">Origin Y (cm):</label><input type="number" id="origin_y" value="0" step="0.1"></div>
                <div class="control-group"><label for="origin_z">Origin Z (cm):</label><input type="number" id="origin_z" value="0" step="0.1"></div>
                <div class="control-group"><button class="generate-btn" onclick="generateCustomPlot()">Generate Custom Plot</button><button class="preview-btn" onclick="generatePreview()">Quick Preview</button></div>
            </div>
            <div class="plot-gallery">
                {% if geometry_views %}
                    {% if geometry_views.xy %}
                    <div class="plot-container"><h3>XY Plane View</h3><img src="data:image/png;base64,{{ geometry_views.xy }}" alt="XY Plane Geometry"></div>
                    {% endif %}
                    {% if geometry_views.xz %}
                    <div class="plot-container"><h3>XZ Plane View</h3><img src="data:image/png;base64,{{ geometry_views.xz }}" alt="XZ Plane Geometry"></div>
                    {% endif %}
                    {% if geometry_views.yz %}
                    <div class="plot-container"><h3>YZ Plane View</h3><img src="data:image/png;base64,{{ geometry_views.yz }}" alt="YZ Plane Geometry"></div>
                    {% endif %}
                    {% if geometry_views.xy_zoom %}
                    <div class="plot-container"><h3>XY Plane (Zoom)</h3><img src="data:image/png;base64,{{ geometry_views.xy_zoom }}" alt="XY Plane Geometry Zoom"></div>
                    {% endif %}
                    {% if geometry_views.simple %}
                    <div class="plot-container"><h3>Simple View</h3><img src="data:image/png;base64,{{ geometry_views.simple }}" alt="Simple Geometry View"></div>
                    {% endif %}
                {% else %}
                <div class="plot-container"><h3>Geometry Plot</h3><div class="no-plot">No geometry plots available. Use the controls above to generate custom plots.</div></div>
                {% endif %}
                <div class="plot-container" id="custom-plot-container" style="display: none;"><h3 id="custom-plot-title">Custom Plot</h3><img id="custom-plot-image" alt="Custom Geometry Plot"></div>
            </div>
        </div>
        {% elif status and 'failed' in status %}
        <div class="card"><h2>‚ùå Simulation Failed</h2><div class="error-message"><strong>Error:</strong> {{ status.split(':', 1)[1] if ':' in status else status }}</div><p>Please check your input files and try submitting the simulation again.</p></div>
        {% elif status == 'running' %}
        <div class="card"><h2>‚è≥ Simulation Running</h2><p>Your simulation is currently being processed. This page will automatically refresh to show results when complete.</p><div style="text-align: center; margin: 30px 0;"><div class="spinner"></div><p>Processing... Please wait.</p></div></div>
        {% elif status == 'queued' %}
        <div class="card"><h2>üìã Simulation Queued</h2><p>Your simulation is in the queue and will start processing shortly.</p><div style="text-align: center; margin: 30px 0;"><div class="spinner"></div><p>Waiting in queue...</p></div></div>
        {% else %}
        <div class="card"><h2>üîç Job Status</h2><p>Job status: <span class="status">{{ status or 'Unknown' }}</span></p>{% if not status %}<div class="error-message">This job was not found. Please check the job ID and try again.</div>{% endif %}</div>
        {% endif %}
    </div>

    <div class="loading-overlay" id="loading-overlay"><div class="loading-content"><div class="spinner"></div><h3>Generating Plot...</h3><p>Please wait while we create your custom geometry plot.</p></div></div>

    <script>
        {% if status in ['running', 'queued'] %}
        setTimeout(() => { window.location.reload(); }, 10000);
        {% endif %}
        function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
        function hideLoading() { document.getElementById('loading-overlay').style.display = 'none'; }
        async function generateCustomPlot() {
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const basis = document.getElementById('basis').value;
            const resolution = document.getElementById('resolution').value;
            const origin_x = document.getElementById('origin_x').value;
            const origin_y = document.getElementById('origin_y').value;
            const origin_z = document.getElementById('origin_z').value;
            showLoading();
            try {
                const params = new URLSearchParams({ width, height, basis, resolution, origin_x, origin_y, origin_z });
                const response = await fetch(`/generate-manual-plot/{{ job_id }}?${params}`);
                const data = await response.json();
                if (data.success) {
                    const container = document.getElementById('custom-plot-container');
                    const title = document.getElementById('custom-plot-title');
                    const image = document.getElementById('custom-plot-image');
                    title.textContent = `Custom ${data.parameters.basis.toUpperCase()} Plot (${data.parameters.width}√ó${data.parameters.height} cm)`;
                    image.src = `data:image/png;base64,${data.plot_data}`;
                    container.style.display = 'block';
                    container.scrollIntoView({ behavior: 'smooth' });
                } else { alert(`Failed to generate plot: ${data.error}`); }
            } catch (error) { alert(`Error generating plot: ${error.message}`); }
            finally { hideLoading(); }
        }
        async function generatePreview() {
            showLoading();
            try {
                const response = await fetch(`/geometry-preview/{{ job_id }}`);
                const data = await response.json();
                if (data.success) {
                    const container = document.getElementById('custom-plot-container');
                    const title = document.getElementById('custom-plot-title');
                    const image = document.getElementById('custom-plot-image');
                    title.textContent = `Quick Preview (${data.analysis.geometry_type})`;
                    image.src = `data:image/png;base64,${data.preview}`;
                    container.style.display = 'block';
                    if (data.analysis.dimensions) {
                        const parts = data.analysis.dimensions.split(' x ');
                        const w = parseFloat(parts[0]); const h = parseFloat(parts[1]);
                        if (!isNaN(w)) document.getElementById('width').value = w;
                        if (!isNaN(h)) document.getElementById('height').value = h;
                    }
                    container.scrollIntoView({ behavior: 'smooth' });
                } else { alert(`Failed to generate preview: ${data.error}`); }
            } catch (error) { alert(`Error generating preview: ${error.message}`); }
            finally { hideLoading(); }
        }
        document.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('change', function() {
                if (this.id === 'width' || this.id === 'height') { this.value = Math.max(0.1, Math.min(1000, this.value)); }
                else if (this.id === 'resolution') { this.value = Math.max(100, Math.min(3000, this.value)); }
            });
        });
    </script>
</body>
</html>

