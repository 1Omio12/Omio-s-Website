<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenMC Simulation Results - Job {{ job_id }}</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#0c0c0c 0%,#1a1a1a 25%,#2d2d2d 50%,#1a1a1a 75%,#000000 100%);background-attachment:fixed;min-height:100vh;color:#fff;padding:20px;position:relative}
        body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 20%,rgba(120,119,198,.1) 0%,transparent 50%),radial-gradient(circle at 80% 80%,rgba(255,118,117,.1) 0%,transparent 50%),radial-gradient(circle at 40% 40%,rgba(162,155,254,.05) 0%,transparent 50%);pointer-events:none;z-index:0}
        .container{max-width:1400px;margin:0 auto;position:relative;z-index:1}
        .back-btn{background:linear-gradient(135deg,#4b5563,#374151);color:#fff;border:none;padding:12px 24px;border-radius:10px;font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s ease;text-decoration:none;display:inline-block;margin-bottom:20px}
        .back-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(75,85,99,.4)}
        .header{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:30px;margin-bottom:30px;text-align:center;box-shadow:0 25px 50px rgba(0,0,0,.5),inset 0 1px 0 rgba(255,255,255,.1)}
        .header h1{font-size:2.5rem;font-weight:600;background:linear-gradient(135deg,#a8edea,#fed6e3,#d299c2,#fef9d7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 0 30px rgba(255,255,255,.3);margin-bottom:10px}
        .job-info{display:flex;justify-content:center;gap:30px;flex-wrap:wrap;margin-top:20px}
        .job-info-item{background:rgba(255,255,255,.1);padding:10px 20px;border-radius:10px;border:1px solid rgba(255,255,255,.2)}
        .job-info-item strong{color:#a8edea}
        .status{padding:8px 16px;border-radius:20px;font-weight:600;display:inline-block;margin:10px 0}
        .status.completed{background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff}
        .status.running{background:linear-gradient(135deg,#f59e0b,#d97706);color:#fff}
        .status.failed{background:linear-gradient(135deg,#ef4444,#dc2626);color:#fff}
        .status.queued{background:linear-gradient(135deg,#3b82f6,#2563eb);color:#fff}
        .content-grid{display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:30px}
        .card{background:rgba(255,255,255,.05);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,.1);border-radius:20px;padding:30px}
        .card h2{color:#a8edea;margin-bottom:20px;font-size:1.5rem}
        .results-table{width:100%;border-collapse:collapse}
        .results-table th,.results-table td{padding:12px 16px;text-align:left;border-bottom:1px solid rgba(255,255,255,.1)}
        .results-table th{background:rgba(255,255,255,.1);color:#a8edea;font-weight:600}
        .results-table tr:hover{background:rgba(255,255,255,.05)}
        .keff-highlight{background:linear-gradient(135deg,rgba(168,237,234,.2),rgba(254,214,227,.2));border-radius:8px;padding:4px 8px;font-weight:600}
        .geometry-section{grid-column:1 / -1}
        .plot-controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px;padding:20px;background:rgba(255,255,255,.1);border-radius:15px;border:1px solid rgba(255,255,255,.2)}
        .control-group{display:flex;flex-direction:column;gap:8px}
        .control-group input,.control-group select{padding:10px 12px;border:2px solid rgba(255,255,255,.2);border-radius:8px;background:rgba(255,255,255,.05);color:#fff;font-size:.9rem}
        .generate-btn{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;padding:12px 20px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer}
        .preview-btn{background:linear-gradient(135deg,#10b981,#059669);color:#fff;border:none;padding:10px 16px;border-radius:6px;font-size:.9rem;font-weight:600;cursor:pointer;margin-top:10px}
        .plot-gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px;margin-top:30px}
        .plot-container{background:rgba(255,255,255,.05);border-radius:15px;padding:20px;border:1px solid rgba(255,255,255,.1);text-align:center}
        .plot-container img{max-width:100%;height:auto;border-radius:10px;box-shadow:0 10px 30px rgba(0,0,0,.3)}
        .no-plot{color:#888;font-style:italic;padding:40px 20px;background:rgba(255,255,255,.02);border-radius:10px;border:2px dashed rgba(255,255,255,.1)}
        .loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:1000}
        .loading-content{background:rgba(255,255,255,.1);backdrop-filter:blur(20px);padding:30px;border-radius:15px;text-align:center;color:#fff}
        .spinner{width:40px;height:40px;border:4px solid rgba(255,255,255,.3);border-top:4px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        @media (max-width:768px){.content-grid{grid-template-columns:1fr}.plot-controls{grid-template-columns:1fr}.plot-gallery{grid-template-columns:1fr}.job-info{flex-direction:column;gap:15px}.header h1{font-size:2rem}}
        .log-card{white-space:pre-wrap; max-height: 300px; overflow: auto; background: rgba(0,0,0,0.4); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1)}
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-btn">‚Üê Back to Home</a>
        <div class="header">
            <h1>üöÄ Simulation Results üöÄ</h1>
            <div class="job-info">
                <div class="job-info-item"><strong>Job ID:</strong> {{ job_id or 'N/A' }}</div>
                <div class="job-info-item"><strong>Cross-Sections:</strong> {{ cross_sections_used or 'N/A' }}</div>
                <div class="job-info-item"><strong>Status:</strong> <span class="status {{ status.split(':')[0] if status else 'unknown' }}">{{ status or 'Unknown' }}</span></div>
            </div>
        </div>

        {% if status == 'completed' %}
        <div class="content-grid">
            <div class="card">
                <h2>üìä Simulation Results</h2>
                {% if results %}
                <table class="results-table"><thead><tr><th>Metric</th><th>Value</th><th>Uncertainty</th></tr></thead><tbody>
                    {% for result in results %}
                    <tr><td>{{ result.metric }}</td><td class="{% if 'k-effective' in result.metric %}keff-highlight{% endif %}">{{ result.value }}</td><td>{{ result.uncertainty }}</td></tr>
                    {% endfor %}
                </tbody></table>
                {% else %}
                <div class="no-plot">No simulation results available.</div>
                {% endif %}
            </div>
            <div class="card">
                <h2>üìà Tally Results</h2>
                {% if plot_data %}
                <div class="plot-container"><img src="data:image/png;base64,{{ plot_data }}" alt="Tally Results Chart"></div>
                {% else %}
                <div class="no-plot">No tally data available.</div>
                {% endif %}
            </div>
        </div>
        <div class="card geometry-section">
            <h2>üîç Geometry Visualization</h2>
            <div class="plot-controls">
                <div class="control-group"><label for="width">Width (cm):</label><input type="number" id="width" value="20" min="0.1" max="1000" step="0.1"></div>
                <div class="control-group"><label for="height">Height (cm):</label><input type="number" id="height" value="20" min="0.1" max="1000" step="0.1"></div>
                <div class="control-group"><label for="basis">View Plane:</label><select id="basis"><option value="xy">XY Plane</option><option value="xz">XZ Plane</option><option value="yz">YZ Plane</option></select></div>
                <div class="control-group"><label for="resolution">Resolution (pixels):</label><input type="number" id="resolution" value="800" min="100" max="3000" step="50"></div>
                <div class="control-group"><label for="origin_x">Origin X (cm):</label><input type="number" id="origin_x" value="0" step="0.1"></div>
                <div class="control-group"><label for="origin_y">Origin Y (cm):</label><input type="number" id="origin_y" value="0" step="0.1"></div>
                <div class="control-group"><label for="origin_z">Origin Z (cm):</label><input type="number" id="origin_z" value="0" step="0.1"></div>
                <div class="control-group"><button class="generate-btn" onclick="generateCustomPlot()">Generate Custom Plot</button><button class="preview-btn" onclick="generatePreview()">Quick Preview</button></div>
            </div>
            <div class="plot-gallery">
                {% if geometry_views %}
                    {% if geometry_views.xy %}<div class="plot-container"><h3>XY Plane View</h3><img src="data:image/png;base64,{{ geometry_views.xy }}" alt="XY Plane Geometry"></div>{% endif %}
                    {% if geometry_views.xz %}<div class="plot-container"><h3>XZ Plane View</h3><img src="data:image/png;base64,{{ geometry_views.xz }}" alt="XZ Plane Geometry"></div>{% endif %}
                    {% if geometry_views.yz %}<div class="plot-container"><h3>YZ Plane View</h3><img src="data:image/png;base64,{{ geometry_views.yz }}" alt="YZ Plane Geometry"></div>{% endif %}
                    {% if geometry_views.xy_zoom %}<div class="plot-container"><h3>XY Plane (Zoom)</h3><img src="data:image/png;base64,{{ geometry_views.xy_zoom }}" alt="XY Plane Geometry Zoom"></div>{% endif %}
                    {% if geometry_views.simple %}<div class="plot-container"><h3>Simple View</h3><img src="data:image/png;base64,{{ geometry_views.simple }}" alt="Simple Geometry View"></div>{% endif %}
                {% else %}
                <div class="plot-container"><h3>Geometry Plot</h3><div class="no-plot">No geometry plots available. Use the controls above to generate custom plots.</div></div>
                {% endif %}
                <div class="plot-container" id="custom-plot-container" style="display:none;"><h3 id="custom-plot-title">Custom Plot</h3><img id="custom-plot-image" alt="Custom Geometry Plot"></div>
            </div>
        </div>
        {% elif status and 'failed' in status %}
        <div class="card"><h2>‚ùå Simulation Failed</h2><div class="no-plot"><strong>Error:</strong> {{ status.split(':', 1)[1] if ':' in status else status }}</div></div>
        {% elif status in ['running', 'queued'] %}
        <div class="card"><h2>‚è≥ Job In Progress</h2><div class="no-plot">This page will auto-refresh.</div></div>
        {% else %}
        <div class="card"><h2>üîç Job Status</h2><p>Job status: <span class="status">{{ status or 'Unknown' }}</span></p></div>
        {% endif %}

        <div class="card" id="log-card" style="margin-top:20px;">
            <h2>üßæ Execution Log</h2>
            <div class="log-card" id="log-output">Loading logs...</div>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay"><div class="loading-content"><div class="spinner"></div><h3>Generating Plot...</h3><p>Please wait while we create your custom geometry plot.</p></div></div>

    <script>
        {% if status in ['running', 'queued'] %}
        setTimeout(() => { window.location.reload(); }, 10000);
        {% endif %}
        function showLoading(){ document.getElementById('loading-overlay').style.display='flex'; }
        function hideLoading(){ document.getElementById('loading-overlay').style.display='none'; }
        async function generateCustomPlot(){
            const width = document.getElementById('width').value;
            const height = document.getElementById('height').value;
            const basis = document.getElementById('basis').value;
            const resolution = document.getElementById('resolution').value;
            const origin_x = document.getElementById('origin_x').value;
            const origin_y = document.getElementById('origin_y').value;
            const origin_z = document.getElementById('origin_z').value;
            showLoading();
            try {
                const params = new URLSearchParams({ width, height, basis, resolution, origin_x, origin_y, origin_z });
                const res = await fetch(`/generate-manual-plot/{{ job_id }}?${params}`);
                const data = await res.json();
                if (data.success) {
                    const container = document.getElementById('custom-plot-container');
                    const title = document.getElementById('custom-plot-title');
                    const image = document.getElementById('custom-plot-image');
                    title.textContent = `Custom ${data.parameters.basis.toUpperCase()} Plot (${data.parameters.width}√ó${data.parameters.height} cm)`;
                    image.src = `data:image/png;base64,${data.plot_data}`;
                    container.style.display = 'block';
                    container.scrollIntoView({ behavior: 'smooth' });
                } else { alert(`Failed to generate plot: ${data.error}`); }
            } catch (e) { alert(`Error: ${e.message}`); } finally { hideLoading(); }
        }
        async function generatePreview(){
            showLoading();
            try {
                const res = await fetch(`/geometry-preview/{{ job_id }}`);
                const data = await res.json();
                if (data.success) {
                    const container = document.getElementById('custom-plot-container');
                    const title = document.getElementById('custom-plot-title');
                    const image = document.getElementById('custom-plot-image');
                    title.textContent = `Quick Preview (${data.analysis.geometry_type})`;
                    image.src = `data:image/png;base64,${data.preview}`;
                    container.style.display = 'block';
                    if (data.analysis.dimensions) {
                        const parts = data.analysis.dimensions.split(' x ');
                        document.getElementById('width').value = parseFloat(parts[0]) || 20;
                        document.getElementById('height').value = parseFloat(parts[1]) || 20;
                    }
                    container.scrollIntoView({ behavior: 'smooth' });
                } else { alert(`Failed to generate preview: ${data.error}`); }
            } catch (e) { alert(`Error: ${e.message}`); } finally { hideLoading(); }
        }
        async function loadLogs(){
            try { const res = await fetch('/logs/{{ job_id }}'); const data = await res.json(); document.getElementById('log-output').textContent = data.log || ''; }
            catch(e){ document.getElementById('log-output').textContent = 'No logs available'; }
        }
        loadLogs();
        setInterval(loadLogs, 4000);
    </script>
</body>
</html>

